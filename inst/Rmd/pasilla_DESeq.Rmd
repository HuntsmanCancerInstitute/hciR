---
title: "DESeq analysis of Pasilla knock-downs"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, comment="# ", collapse=TRUE)
library(hciR)
library(DT)
```

This guide follows the [Bioconductor RNA-Seq workflow] to find differentially expressed
genes using [DESeq2].  Load the [hciR] and [pasilla] packages to run the [R] code.

You can render this HTML report by finding the path to the [pasilla_DESeq.Rmd] file in `inst/Rmd`.

```{r render, eval=FALSE}
library(hciR)
library(rmarkdown)
rmd <- system.file("Rmd", "pasilla_DESeq.Rmd", package="hciR")
render(rmd, output_dir=".")
```


### Load samples and counts

Load the [pasilla] counts and samples in the `extdata` directory using the [readr] package.


```{r load_samples, message=FALSE, echo=2:6}
options(width=120)
library(readr)
extdata <- system.file("extdata", package="pasilla")
counts  <- read_tsv(paste(extdata, "pasilla_gene_counts.tsv", sep="/"))
samples <- read_csv(paste(extdata, "pasilla_sample_annotation.csv", sep="/"))
samples
```


Remove 2240 features with zero counts and 1323 with one or fewer reads in any sample.

```{r filter_counts}
counts <- filter_counts(counts)
counts
```


### Run DESeq

To run the DESeq2 wrapper for tibbles, the names in the first sample column
 should match the count column names, so fix the file name
 (the names should be identical, but the order does not matter).

```{r fix_file}
samples$file <- gsub("fb$", "", samples$file )
```


Combine the counts and samples to create a `DESeqDataSet` object and calculate
the regularized log transform (rlog) for sample visualizations.

```{r DESeqobject}
dds <- deseq_from_tibble(counts, samples,  design = ~ condition)
rld <- r_log(dds)
```

### PCA plot

Plot the first two principal components using the rlog values from the top 500 variable genes.
You can hover over points to view sample names or zoom into groups of points in this interactive [highchart].

```{r pcaplot}
plot_pca(rld, "condition", tooltip=c("file", "type") , width=700)
```

Cluster all the rlog values using the R function `dist` to calculate the Euclidean distance between samples.

```{r dist}
# plot_dist(rld , c("condition", "type") )
plot_dist(rld , c("condition", "type"), palette="Blues", diagNA=FALSE, reverse_pal=TRUE)
```

### Gene annotations

Load fruitfly annotations from Ensembl.

```{r biomaRt}
fly <- read_biomart("fly")
fly
```

### Result tables

Get the annotated DESeq results using a 5% false discovery rate (FDR).  The default is to compare
all treatment combinations, which only includes one in this study.

Since we downloaded the most recent fly annotations, there are 723 missing (note you could set the version
in read_biomart to match the old count table)


```{r DESeq_results}
res <- results_all(dds, fly, alpha= 0.05)
```


### Browse results

Create a [flex dashboard] using the top 2000 genes sorted by p-value in
[pasilla_flex.html].   The [MA-plot] and [volcano plot] are linked, so you can
click and drag to create a box to highlight points and then view matching rows
in the table. You can also drag the box around the plot to easily highlight
other points and rows. In addition, you can search for genes in the table using
the search box, but need to click on the row in order to highlight the points in
the plots.  The sliders can also be used to limit the results.

```{r flex_dash, message=FALSE, eval=FALSE}
rmd <- system.file("Rmd", "DESeq_flex.Rmd", package="hciR")
render(rmd, output_file="pasilla_flex.html",  output_dir=".",
         params=list( results= res, title = "Pasilla treated vs. untreated", top= 2000 ))
```

### Save results

Save the DESeq results to a single Excel file in [pasilla_DESeq.xlsx].  The `write_deseq` function will also
output raw counts, rlog values, normalized counts, samples and fly annotations.

```{r write, eval=FALSE}
write_deseq(res, dds, rld, fly, file="pasilla_DESeq.xlsx")
```



### Plots

Plot the fold changes and p-values in an interactive volcano plot.

```{r volcano}
plot_volcano(res, ggplot=TRUE)
plot_volcano(res, padj = 1e-10, log2Fold =1 , width=700)
```

<br>

Select the top 40 genes sorted by p-value and cluster the rlog differences,
so values in the heatmap represent the amount a gene deviates in a specific sample
from the geneâ€™s average across all samples.

<br>

```{r plot1, fig.width=8, fig.height=7}
x <- top_counts( res, rld, top=40)
x
plot_genes(x, c("condition", "type") )
```
<br>


Plot the top 400 genes using an interactive [d3heatmap].  Click and drag over a
region in the plot to zoom and better view gene labels.

```{r plotd3, fig.width=8, fig.height=9}
plot_genes( top_counts( res, rld, top=400), output="d3", xaxis_font_size=12, show_grid=FALSE)
```

<br>
<br>


[readr]: http://readr.tidyverse.org/
[highchart]: http://jkunst.com/highcharter/index.html
[pasilla]: http://bioconductor.org/packages/release/data/experiment/html/pasilla.html
[R for Data Science]: http://r4ds.had.co.nz/
[R]: https://www.r-project.org
[Bioconductor RNA-Seq workflow]: http://www.bioconductor.org/help/workflows/rnaseqGene
[DESeq2]: http://www.bioconductor.org/packages/release/bioc/html/DESeq2.html
[hciR]: https://github.com/HuntsmanCancerInstitute/hciR
[pheatmap]: https://cran.r-project.org/web/packages/pheatmap/index.html
[d3heatmap]: http://www.htmlwidgets.org/showcase_d3heatmap.html

[flex dashboard]: http://rmarkdown.rstudio.com/flexdashboard/
[MA-plot]: https://en.wikipedia.org/wiki/MA_plot
[volcano plot]: https://en.wikipedia.org/wiki/Volcano_plot_(statistics)
[pasilla_flex.html]: https://huntsmancancerinstitute.github.io/hciR/pasilla_flex.html
[pasilla_DESeq.xlsx]: https://huntsmancancerinstitute.github.io/hciR/pasilla_DESeq.xlsx
[pasilla_DESeq.Rmd]: https://github.com/HuntsmanCancerInstitute/hciR/blob/master/inst/Rmd/pasilla_DESeq.Rmd
